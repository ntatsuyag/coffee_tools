import Head from 'next/head'
import React, { useCallback, useMemo, useState } from 'react'
import {
  Button,
  Container,
  Divider,
  Group,
  NumberInput,
  Paper,
  Slider,
  Stack,
  Text,
  Title,
} from '@mantine/core'
import { useWaterCalculation } from '../hooks/useWaterCalculation'

const presetWeights = [15, 20, 25, 30, 40]

const DEFAULT_BREW_STEP_COUNT = 3
const brewStepTemplates: Array<{ label: string; defaultMultiplier: number }> = [
  { label: '1ãƒ‰ãƒªãƒƒãƒ—ç›®', defaultMultiplier: 0.15 },
  { label: '2ãƒ‰ãƒªãƒƒãƒ—ç›®', defaultMultiplier: 0.3 },
  { label: '3ãƒ‰ãƒªãƒƒãƒ—ç›®', defaultMultiplier: 0.45 },
  { label: '4ãƒ‰ãƒªãƒƒãƒ—ç›®', defaultMultiplier: 0.7 },
  { label: '5ãƒ‰ãƒªãƒƒãƒ—ç›®', defaultMultiplier: 1 },
]
const brewStepMarks = brewStepTemplates.map((_, index) => ({
  value: index + 1,
  label: String(index + 1),
}))

const formatWeight = (value: number) => (Number.isFinite(value) ? Math.round(value * 10) / 10 : 0)

export default function Home() {
  const {
    coffeeGram,
    ratio,
    totalWater,
    handleCoffeeChange,
    handlePresetSelect,
    handleRatioChange,
  } = useWaterCalculation()
  const [brewStepCount, setBrewStepCount] = useState(DEFAULT_BREW_STEP_COUNT)
  const [brewStepMultipliers, setBrewStepMultipliers] = useState(() =>
    brewStepTemplates.map(({ defaultMultiplier }) => defaultMultiplier)
  )
  const { activeBrewSteps, sanitizedMultipliers } = useMemo(() => {
    const sanitized: number[] = []
    brewStepTemplates.forEach(({ defaultMultiplier }, index) => {
      const rawValue = brewStepMultipliers[index] ?? defaultMultiplier
      const clamped = Math.min(Math.max(rawValue, 0), 1)
      const previous = index === 0 ? 0 : sanitized[index - 1]
      sanitized[index] = Math.max(clamped, previous)
    })
    const steps = sanitized.slice(0, brewStepCount).map((multiplier, index) => {
      const previous = index === 0 ? 0 : sanitized[index - 1]
      const diff = multiplier - previous
      return {
        label: brewStepTemplates[index].label,
        multiplier,
        increment: index === 0 || diff <= 0 ? undefined : diff,
      }
    })
    return { activeBrewSteps: steps, sanitizedMultipliers: sanitized }
  }, [brewStepCount, brewStepMultipliers])
  const handleBrewStepCountChange = useCallback((value: number) => {
    const normalized = Math.max(1, Math.min(brewStepTemplates.length, Math.round(value)))
    setBrewStepCount(normalized)
    setBrewStepMultipliers((prev) => {
      const next = [...prev]
      for (let i = 1; i < normalized; i += 1) {
        if (next[i] < next[i - 1]) {
          next[i] = next[i - 1]
        }
      }
      return next
    })
  }, [])
  const handleBrewStepMultiplierChange = useCallback(
    (index: number) => (value: number | string) => {
      const parsed =
        typeof value === 'number' ? value : Number.isFinite(Number(value)) ? Number(value) : NaN
      if (!Number.isFinite(parsed)) return
      setBrewStepMultipliers((prev) => {
        const next = [...prev]
        const lowerBound = index === 0 ? 0 : next[index - 1]
        const newValue = Math.min(Math.max(parsed, lowerBound), 1)
        if (next[index] === newValue) return prev
        next[index] = newValue
        for (let i = index + 1; i < next.length; i += 1) {
          if (next[i] < next[i - 1]) {
            next[i] = next[i - 1]
          } else {
            break
          }
        }
        return next
      })
    },
    []
  )

  return (
    <>
      <Head>
        <title>Coffee tools</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/coffee.png" />
      </Head>

      <Container size="sm" py="xl">
        <Stack gap="xl">
          <Stack gap="xs" align="center">
            <Title order={1} c="var(--mantine-color-coffee-7)">
              â˜•ï¸ Coffee tools
            </Title>
            <Text c="var(--mantine-color-coffee-6)">æ‰‹è»½ã«ãƒ‰ãƒªãƒƒãƒ—ãƒ¬ã‚·ãƒ”ã‚’è¨ˆç®—ã—ã¾ã—ã‚‡ã†ã€‚</Text>
          </Stack>

          <Paper withBorder shadow="md" radius="lg" p="xl" bg="var(--mantine-color-coffee-0)">
            <Stack gap="md">
              <Title order={2} c="var(--mantine-color-coffee-8)">
                {brewStepCount}å›æŠ½å‡ºã®æ°´é‡è¨ˆç®—ãƒ„ãƒ¼ãƒ«
              </Title>
              <Text size="sm">ã‚³ãƒ¼ãƒ’ãƒ¼ã®é‡ã• (g) ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚</Text>

              <NumberInput
                label="ã‚³ãƒ¼ãƒ’ãƒ¼ã®é‡ã• (g)"
                min={0}
                hideControls
                value={coffeeGram}
                onChange={handleCoffeeChange}
                placeholder="ä¾‹: 20"
              />

              <Group gap="xs" wrap="wrap">
                {presetWeights.map((weight) => (
                  <Button
                    key={weight}
                    variant={coffeeGram === weight ? 'filled' : 'light'}
                    onClick={() => handlePresetSelect(weight)}
                    size="sm"
                  >
                    {weight} g
                  </Button>
                ))}
              </Group>
              <Text size="sm" c="var(--mantine-color-coffee-6)">
                ã‚³ãƒ¼ãƒ’ãƒ¼:æ°´ = 1:{ratio} ã®å‰²åˆã§æ°´é‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
              </Text>

              <Divider label="ãƒ¬ã‚·ãƒ”" labelPosition="center" />
              <Stack gap="sm">
                <Text fw={600}>å…¨æ°´é‡: {formatWeight(totalWater)} g</Text>
                {activeBrewSteps.map(({ label, multiplier, increment }) => {
                  const amount = formatWeight(totalWater * multiplier)
                  const incrementText =
                    typeof increment === 'number'
                      ? ` (+${formatWeight(totalWater * increment)}g)`
                      : ''
                  return (
                    <Text key={label}>
                      {label}: {amount} g{incrementText}
                    </Text>
                  )
                })}
              </Stack>
            </Stack>
          </Paper>

          <Paper withBorder shadow="sm" radius="lg" p="xl" bg="var(--mantine-color-coffee-1)">
            <Stack gap="md">
              <Title order={2}>ğŸ”§ è¨­å®š</Title>
              <Text size="sm">ã‚³ãƒ¼ãƒ’ãƒ¼ã®é‡ã• (g) ã«å¯¾ã™ã‚‹æ°´é‡ã®å‰²åˆã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</Text>

              <Stack gap="xs">
                <Group justify="space-between" align="center">
                  <Text size="sm" fw={500}>
                    å‰²åˆ (1:n)
                  </Text>
                  <Text fw={600}>{ratio}</Text>
                </Group>
                <Slider
                  min={1}
                  max={20}
                  step={1}
                  marks={[
                    { value: 5, label: '5' },
                    { value: 10, label: '10' },
                    { value: 15, label: '15' },
                    { value: 20, label: '20' },
                  ]}
                  value={ratio}
                  onChange={handleRatioChange}
                />
              </Stack>
              <Stack gap="xs">
                <Group justify="space-between" align="center">
                  <Text size="sm" fw={500}>
                    æŠ½å‡ºå›æ•°
                  </Text>
                  <Text fw={600}>{brewStepCount}</Text>
                </Group>
                <Slider
                  min={1}
                  max={brewStepTemplates.length}
                  step={1}
                  marks={brewStepMarks}
                  value={brewStepCount}
                  onChange={handleBrewStepCountChange}
                />
              </Stack>
              <Stack gap="xs">
                <Text size="sm" fw={500}>
                  æŠ½å‡ºç‡è¨­å®š (ç´¯è¨ˆæ¯”ç‡)
                </Text>
                {activeBrewSteps.map((step, index) => (
                  <NumberInput
                    key={step.label}
                    label={step.label}
                    min={0}
                    max={1}
                    step={0.05}
                    hideControls
                    value={sanitizedMultipliers[index]}
                    onChange={handleBrewStepMultiplierChange(index)}
                  />
                ))}
                <Text size="xs" c="dimmed">
                  0ã€œ1ã®ç¯„å›²ã§èª¿æ•´ã§ãã¾ã™ã€‚å¾Œã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ã»ã©å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ä»¥ä¸Šã®å€¤ãŒç¶­æŒã•ã‚Œã¾ã™ã€‚
                </Text>
              </Stack>
            </Stack>
          </Paper>

          <Text ta="center" c="dimmed">
            ğŸ¤ enjoy your coffee time ğŸ¤
          </Text>
        </Stack>
      </Container>
    </>
  )
}
